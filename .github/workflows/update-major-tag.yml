name: Update major version tag/release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  update-major-tag:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get release and set is_stable
        id: get_release
        uses: actions/github-script@v7
        with:
          script: |
            const tag = context.ref.replace('refs/tags/', '');
            try {
              const { data: release } = await octokit.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag,
              });
              core.setOutput('is_stable', release.prerelease === false ? 'true' : 'false');
            } catch (err) {
              if (err.status === 404) {
                core.setOutput('is_stable', 'false');
              } else {
                throw err;
              }
            }

      - name: Update major tag
        if: steps.get_release.outputs.is_stable == 'true'
        uses: haya14busa/action-update-semver@v1
        with:
          major_version_tag_only: true
          tag: ${{ github.ref_name }}

      - name: Update major release description
        if: steps.get_release.outputs.is_stable == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const tag = context.ref.replace('refs/tags/', '');
            const majorTag = tag.split('.')[0];
            try {
              const { data: release } = await octokit.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: majorTag,
              });
              const newBody = `Major ${majorTag}. Keeps updated to the latest version in this major (${tag}).`;
              await octokit.rest.repos.updateRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: release.id,
                body: newBody,
              });
            } catch (err) {
              if (err.status === 404) {
                console.log(`No release found for major tag ${majorTag}, skipping description update`);
              } else {
                throw err;
              }
            }
